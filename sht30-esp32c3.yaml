esphome:
  name: myesp32c3-SHT30
  friendly_name: "SHT30 ESP32-C3 Sensor"

esp32:
  board: airm2m_core_esp32c3
  framework:
    type: arduino

# ä»secrets.yamlæ–‡ä»¶ä¸­è¯»å–WiFié…ç½®
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # WiFiè¿æ¥å¤±è´¥æ—¶çš„å¤„ç†
  ap:
    ssid: "ESP32C3-SHT30 Fallback Hotspot"
    password: "12345678"

  # WiFiè¿æ¥çŠ¶æ€å›è°ƒ
  on_connect:
    - logger.log: "WiFiè¿æ¥æˆåŠŸï¼"
  on_disconnect:
    - logger.log: "WiFiè¿æ¥æ–­å¼€ï¼"

# UARTé…ç½® - ç”¨äºè¯»å–SHT30ä¼ æ„Ÿå™¨æ•°æ®
uart:
  id: uart_bus
  tx_pin: GPIO0  # TXå¼•è„š - å¦‚æœéœ€è¦å‘é€å‘½ä»¤åˆ°ä¼ æ„Ÿå™¨
  rx_pin: GPIO1  # RXå¼•è„š - æ¥æ”¶ä¼ æ„Ÿå™¨æ•°æ®
  baud_rate: 9600  # å°è¯•æ›´é«˜çš„æ³¢ç‰¹ç‡
  data_bits: 8
  parity: NONE
  stop_bits: 1
  rx_buffer_size: 512  # å¢åŠ æ¥æ”¶ç¼“å†²åŒºå¤§å°
  # debug:  # å…³é—­UARTè°ƒè¯•ä»¥å‡å°‘æ—¥å¿—è¾“å‡º
  #   direction: RX
  #   dummy_receiver: false

# å…¨å±€å˜é‡å­˜å‚¨UARTæ•°æ®ç¼“å†²åŒºå’Œä¸Šæ¬¡æ•°å€¼
globals:
  - id: uart_buffer
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: last_temperature
    type: float
    restore_value: no
    initial_value: '-999.0'  # åˆå§‹å€¼è®¾ä¸ºä¸å¯èƒ½çš„æ¸©åº¦
  - id: last_humidity
    type: float
    restore_value: no
    initial_value: '-999.0'  # åˆå§‹å€¼è®¾ä¸ºä¸å¯èƒ½çš„æ¹¿åº¦

sensor:
  # SHT30 UARTä¼ æ„Ÿå™¨ - æ¸©åº¦
  - platform: template
    name: "SHT30 UART Temperature"
    id: sht30_temp
    unit_of_measurement: "Â°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1

  # SHT30 UARTä¼ æ„Ÿå™¨ - æ¹¿åº¦
  - platform: template
    name: "SHT30 UART Humidity"
    id: sht30_hum
    unit_of_measurement: "%"
    device_class: humidity
    state_class: measurement
    accuracy_decimals: 1

  # WiFiä¿¡å·å¼ºåº¦ä¼ æ„Ÿå™¨
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  # è®¾å¤‡è¿è¡Œæ—¶é—´ä¼ æ„Ÿå™¨
  - platform: uptime
    name: "Uptime"
    update_interval: 60s

  # ESP32-C3å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨
  - platform: internal_temperature
    name: "ESP32-C3 Internal Temperature"
    update_interval: 60s

# UARTæ•°æ®å¤„ç†é—´éš”
interval:
  - interval: 100ms  # æ¯100msæ£€æŸ¥ä¸€æ¬¡UARTæ•°æ®
    then:
      - lambda: |-
          // æ£€æŸ¥UARTæ˜¯å¦æœ‰å¯ç”¨æ•°æ®
          int available = id(uart_bus).available();
          if (available > 0) {
            // ç®€åŒ–æ—¥å¿—è¾“å‡ºï¼Œåªåœ¨è°ƒè¯•æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            // ESP_LOGD("sht30_uart", "UARTç¼“å†²åŒºæœ‰ %d å­—èŠ‚å¯ç”¨æ•°æ®", available);

            // ä½¿ç”¨æ•°ç»„è¯»å–æ–¹å¼
            uint8_t data[256];
            std::string received_data = "";

            // å°è¯•è¯»å–æ‰€æœ‰å¯ç”¨æ•°æ®
            int bytes_read = 0;
            uint8_t buffer[1];

            // å¾ªç¯è¯»å–å•ä¸ªå­—èŠ‚
            while (id(uart_bus).available() && bytes_read < 256) {
              if (id(uart_bus).read_array(buffer, 1) > 0) {
                received_data += (char)buffer[0];
                bytes_read++;
              } else {
                break;
              }
            }

            // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®è¡Œ
            for (char c : received_data) {
              if (c == '\n' || c == '\r') {
                if (!id(uart_buffer).empty()) {
                  std::string line = id(uart_buffer);
                  // ESP_LOGD("sht30_uart", "å®Œæ•´è¡Œæ•°æ®: '%s'", line.c_str());

                  // è§£æSHT30æ•°æ®æ ¼å¼: R:070.0RH 031.5C
                  if (line.find("R:") == 0 && line.find("RH") != std::string::npos && line.find("C") != std::string::npos) {
                    ESP_LOGI("sht30_uart", "æ£€æµ‹åˆ°SHT30æ•°æ®æ ¼å¼ï¼Œå¼€å§‹è§£æ: '%s'", line.c_str());

                    // æŸ¥æ‰¾æ¹¿åº¦æ•°æ® (RHå‰çš„æ•°å­—)
                    size_t rh_pos = line.find("RH");
                    if (rh_pos != std::string::npos && rh_pos > 2) {
                      // ä»R:åå¼€å§‹æŸ¥æ‰¾æ¹¿åº¦å€¼
                      std::string humidity_str = line.substr(2, rh_pos - 2);
                      float humidity = atof(humidity_str.c_str());

                      // æ¹¿åº¦æç«¯å€¼è¿‡æ»¤ (0-100%)
                      if (humidity >= 0.0 && humidity <= 100.0) {
                        // æ£€æŸ¥æ•°å€¼å˜åŒ–æ˜¯å¦è¶³å¤Ÿå¤§ (å˜åŒ–è¶…è¿‡0.5%æ‰æ›´æ–°)
                        if (id(last_humidity) == -999.0 || abs(humidity - id(last_humidity)) >= 0.5) {
                          ESP_LOGI("sht30_uart", "æ¹¿åº¦: %.1f%%", humidity);
                          id(sht30_hum).publish_state(humidity);
                          id(last_humidity) = humidity;
                        }
                      } else {
                        ESP_LOGW("sht30_uart", "æ¹¿åº¦å¼‚å¸¸å€¼è¢«è¿‡æ»¤ - åŸå§‹æ•°æ®: '%s', è§£æå€¼: %.1f%%, æœ‰æ•ˆèŒƒå›´: 0-100%%", line.c_str(), humidity);
                      }
                    }

                    // æŸ¥æ‰¾æ¸©åº¦æ•°æ® (Cå‰çš„æ•°å­—)
                    size_t c_pos = line.find("C");
                    size_t space_pos = line.find(" ");
                    if (c_pos != std::string::npos && space_pos != std::string::npos && c_pos > space_pos) {
                      // ä»ç©ºæ ¼åå¼€å§‹æŸ¥æ‰¾æ¸©åº¦å€¼
                      std::string temp_str = line.substr(space_pos + 1, c_pos - space_pos - 1);
                      float temperature = atof(temp_str.c_str());

                      // æ¸©åº¦æç«¯å€¼è¿‡æ»¤ (-40Â°C åˆ° 80Â°C)
                      if (temperature >= -40.0 && temperature <= 80.0) {
                        // æ£€æŸ¥æ•°å€¼å˜åŒ–æ˜¯å¦è¶³å¤Ÿå¤§ (å˜åŒ–è¶…è¿‡0.2Â°Cæ‰æ›´æ–°)
                        if (id(last_temperature) == -999.0 || abs(temperature - id(last_temperature)) >= 0.2) {
                          ESP_LOGI("sht30_uart", "æ¸©åº¦: %.1fÂ°C", temperature);
                          id(sht30_temp).publish_state(temperature);
                          id(last_temperature) = temperature;
                        }
                      } else {
                        ESP_LOGW("sht30_uart", "æ¸©åº¦å¼‚å¸¸å€¼è¢«è¿‡æ»¤ - åŸå§‹æ•°æ®: '%s', è§£æå€¼: %.1fÂ°C, æœ‰æ•ˆèŒƒå›´: -40~80Â°C", line.c_str(), temperature);
                      }
                    }
                  } else if (!line.empty()) {
                    // è®°å½•æ— æ³•è§£æçš„æ•°æ®æ ¼å¼
                    ESP_LOGW("sht30_uart", "æ— æ³•è§£æçš„æ•°æ®æ ¼å¼ - åŸå§‹æ•°æ®: '%s'", line.c_str());
                  }

                  id(uart_buffer) = "";
                }
              } else {
                id(uart_buffer) += c;
                if (id(uart_buffer).length() > 200) {
                  id(uart_buffer) = "";
                }
              }
            }
          }

  # å¯é€‰ï¼šå®šæœŸå‘é€è¯»å–å‘½ä»¤åˆ°ä¼ æ„Ÿå™¨
  - interval: 5s
    then:
      - uart.write:
          id: uart_bus
          data: "READ\r\n"  # å‘é€è¯»å–å‘½ä»¤åˆ°ä¼ æ„Ÿå™¨ï¼ˆå¦‚æœä¼ æ„Ÿå™¨éœ€è¦å‘½ä»¤è§¦å‘ï¼‰

# # çŠ¶æ€LEDæŒ‡ç¤º
# light:
#   - platform: status_led
#     name: "Status LED"
#     pin: GPIO13  # ESP32-C3å¼€å‘æ¿ä¸Šçš„LEDå¼•è„š

# æ–‡æœ¬ä¼ æ„Ÿå™¨
text_sensor:
  # WiFiä¿¡æ¯
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "Connected SSID"
    mac_address:
      name: "Mac Address"

# äºŒè¿›åˆ¶ä¼ æ„Ÿå™¨
binary_sensor:
  # è®¾å¤‡çŠ¶æ€
  - platform: status
    name: "Status"

# å¼€å…³æ§åˆ¶
switch:
  # é‡å¯å¼€å…³
  - platform: restart
    name: "Restart"

# æ—¥å¿—é…ç½®
logger:
  baud_rate: 115200
  level: WARN  # åªæ˜¾ç¤ºé‡è¦ä¿¡æ¯
  logs:
    sht30_uart: WARN  # åªæ˜¾ç¤ºä¼ æ„Ÿå™¨æ•°æ®
    uart_debug: WARN  # å‡å°‘UARTè°ƒè¯•ä¿¡æ¯
    uart: WARN        # å‡å°‘UARTæ—¥å¿—
    wifi: WARN        # å‡å°‘WiFiæ—¥å¿—
    api: WARN         # å‡å°‘APIæ—¥å¿—
    ota: WARN         # å‡å°‘OTAæ—¥å¿—
    web_server: WARN  # å‡å°‘WebæœåŠ¡å™¨æ—¥å¿—

# OTAæ›´æ–°
ota:
  platform: esphome

# APIé…ç½®
api:
  # use_address: 192.168.0.109  # ğŸ‘ˆ å¼ºåˆ¶è¿æ¥è¯¥åœ°å€

# WebæœåŠ¡å™¨
web_server:
  port: 80
  auth:
    username: admin
    password: !secret wifi_password

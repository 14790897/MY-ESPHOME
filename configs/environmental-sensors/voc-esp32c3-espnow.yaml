esphome:
  name: voc-myesp32c3-espnow
  friendly_name: "VOC-CO2-HCHO ESP32-C3 Sensor (ESP-NOW)"

esp32:
  board: airm2m_core_esp32c3
  framework:
    type: arduino


# ä»secrets.yamlæ–‡ä»¶ä¸­è¯»å–WiFié…ç½®
wifi:
  id: main_wifi
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # WiFiè¿æ¥å¤±è´¥æ—¶çš„å¤„ç†
  ap:
    ssid: "ESP32C3-VOC Fallback Hotspot"
    password: "12345678"

  # WiFiè¿æ¥çŠ¶æ€å›è°ƒ
  on_connect:
    - logger.log: "WiFiè¿æ¥æˆåŠŸï¼"
  on_disconnect:
    - logger.log: "WiFiè¿æ¥æ–­å¼€ï¼"

# ESP-NOWé…ç½®
espnow:
  wifi_id: main_wifi
  peers:
    - id: voc_gateway
      mac_address: !secret voc_espnow_gateway_mac  # åœ¨secrets.yamlä¸­é…ç½®æ¥æ”¶ç«¯MACåœ°å€
      channel: 1

# UARTé…ç½® - ç”¨äºè¯»å–VOC-CO2-HCHOä¼ æ„Ÿå™¨æ•°æ®
uart:
  id: uart_bus
  tx_pin: GPIO0  # TXå¼•è„š - æ¥ä¼ æ„Ÿå™¨RX
  rx_pin: GPIO1  # RXå¼•è„š - æ¥ä¼ æ„Ÿå™¨TX
  baud_rate: 9600  # VOCä¼ æ„Ÿå™¨æ³¢ç‰¹ç‡
  data_bits: 8
  parity: NONE
  stop_bits: 1
  rx_buffer_size: 512  # å¢åŠ æ¥æ”¶ç¼“å†²åŒºå¤§å°

# å…¨å±€å˜é‡å­˜å‚¨VOCä¼ æ„Ÿå™¨æ•°æ®å’Œä¸Šæ¬¡æ•°å€¼
globals:
  - id: last_tvoc
    type: float
    restore_value: no
    initial_value: '-999.0'  # åˆå§‹å€¼è®¾ä¸ºä¸å¯èƒ½çš„TVOCæµ“åº¦
  - id: last_hcho
    type: float
    restore_value: no
    initial_value: '-999.0'  # åˆå§‹å€¼è®¾ä¸ºä¸å¯èƒ½çš„ç”²é†›æµ“åº¦
  - id: last_co2
    type: float
    restore_value: no
    initial_value: '-999.0'  # åˆå§‹å€¼è®¾ä¸ºä¸å¯èƒ½çš„CO2æµ“åº¦
  - id: last_air_quality
    type: std::string
    restore_value: no
    initial_value: '"æœªçŸ¥"'  # åˆå§‹ç©ºæ°”è´¨é‡çŠ¶æ€
  - id: last_espnow_payload
    type: std::string
    restore_value: no
    initial_value: '"{}"'

script:
  - id: send_voc_payload_over_espnow
    mode: queued
    then:
      - if:
          condition:
            lambda: 'return id(last_espnow_payload).size() > 2;'
          then:
            - espnow.send:
                peer_id: voc_gateway
                data: !lambda 'return id(last_espnow_payload);'

sensor:
  # VOC-CO2-HCHOä¼ æ„Ÿå™¨æ•°æ®
  - platform: template
    name: "TVOC"
    id: voc_tvoc
    unit_of_measurement: "mg/mÂ³"
    accuracy_decimals: 3
    state_class: "measurement"
    icon: "mdi:chemical-weapon"

  - platform: template
    name: "Formaldehyde (CHâ‚‚O)"
    id: voc_hcho
    unit_of_measurement: "mg/mÂ³"
    accuracy_decimals: 3
    state_class: "measurement"
    icon: "mdi:molecule"

  - platform: template
    name: "CO2"
    id: voc_co2
    unit_of_measurement: "mg/mÂ³"
    accuracy_decimals: 3
    state_class: "measurement"
    icon: "mdi:molecule-co2"

  # ESP32-C3å†…éƒ¨æ¸©åº¦ä¼ æ„Ÿå™¨
  - platform: internal_temperature
    name: "ESP32-C3 Internal Temperature"
    update_interval: 60s

# VOCä¼ æ„Ÿå™¨æ•°æ®å¤„ç†é—´éš” - ä¸¥æ ¼æŒ‰ç…§test_VOC-CO2-HCHO-Sensor.cppå®ç°
interval:
  - interval: 2000ms  # æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡UARTæ•°æ®ï¼Œä¸C++ä»£ç çš„READ_INTERVALä¸€è‡´
    then:
      - lambda: |-
          ESP_LOGI("voc_uart", "â° å¼€å§‹è¯»å–21VOCä¼ æ„Ÿå™¨æ•°æ®");

          // æ¸…ç©ºæ¥æ”¶ç¼“å†²åŒºä¸­çš„æ—§æ•°æ® (åƒC++ä»£ç ä¸€æ ·)
          int cleared = 0;
          uint8_t dummy_buffer[1];
          while (id(uart_bus).available()) {
            if (id(uart_bus).read_array(dummy_buffer, 1) > 0) {
              cleared++;
            }
            delay(1);
          }
          if (cleared > 0) {
            ESP_LOGI("voc_uart", "æ¸…ç©ºäº†%då­—èŠ‚æ—§æ•°æ®", cleared);
          }

          // ç­‰å¾…æ•°æ®åˆ°è¾¾ï¼Œè¶…æ—¶2ç§’ (åƒC++ä»£ç ä¸€æ ·)
          uint8_t buffer[64];
          int bytesRead = 0;
          unsigned long startTime = millis();

          while (bytesRead < 64 && (millis() - startTime) < 2000) {
            if (id(uart_bus).available()) {
              uint8_t single_byte[1];
              if (id(uart_bus).read_array(single_byte, 1) > 0) {
                buffer[bytesRead] = single_byte[0];
                bytesRead++;
              }

              // å¦‚æœè¿ç»­æ²¡æœ‰æ–°æ•°æ®è¶…è¿‡100msï¼Œè®¤ä¸ºä¸€å¸§æ•°æ®æ¥æ”¶å®Œæˆ
              unsigned long lastByteTime = millis();
              while (!id(uart_bus).available() && (millis() - lastByteTime) < 100) {
                delay(5);
              }
              if (!id(uart_bus).available()) {
                break;
              }
            }
            delay(10);
          }

          if (bytesRead > 0) {
            // è°ƒè¯•ï¼šæ˜¾ç¤ºæ¥æ”¶åˆ°çš„åŸå§‹æ•°æ®
            ESP_LOGI("voc_uart", "ğŸ“¡ æ¥æ”¶åˆ° %d å­—èŠ‚:", bytesRead);
            std::string hex_data = "";
            for (int i = 0; i < bytesRead; i++) {
              char hex_str[4];
              sprintf(hex_str, "%02X ", buffer[i]);
              hex_data += hex_str;
            }
            ESP_LOGI("voc_uart", "åŸå§‹æ•°æ®: %s", hex_data.c_str());

            // è§£ææ¥æ”¶åˆ°çš„æ•°æ® - ä¸¥æ ¼æŒ‰ç…§C++ä»£ç çš„parseVOCDataå‡½æ•°
            ESP_LOGI("voc_uart", "ğŸ” è§£ææ•°æ®: é•¿åº¦=%d", bytesRead);

            // æ£€æŸ¥æ•°æ®å¸§é•¿åº¦ (æ ¹æ®æ–‡æ¡£åº”è¯¥æ˜¯9å­—èŠ‚)
            if (bytesRead < 9) {
              ESP_LOGW("voc_uart", "æ•°æ®é•¿åº¦ä¸è¶³ï¼ˆéœ€è¦9å­—èŠ‚ï¼Œå®é™…%då­—èŠ‚ï¼‰", bytesRead);
              return;
            }

            // å¯»æ‰¾æ­£ç¡®çš„æ•°æ®å¸§èµ·å§‹ä½ç½® (0x2Cæ¨¡å—åœ°å€å¼€å¤´)
            int frameStart = -1;
            for (int i = 0; i <= bytesRead - 9; i++) {
              if (buffer[i] == 0x2C && (i + 1 < bytesRead) && buffer[i + 1] == 0xE4) {
                frameStart = i;
                ESP_LOGI("voc_uart", "æ‰¾åˆ°å¸§å¤´0x2C 0xE4åœ¨ä½ç½®%d", i);
                break;
              }
            }

            if (frameStart == -1) {
              ESP_LOGW("voc_uart", "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®å¸§å¤´ (0x2C 0xE4)");
              return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å­—èŠ‚
            if (frameStart + 9 > bytesRead) {
              ESP_LOGW("voc_uart", "æ•°æ®å¸§ä¸å®Œæ•´ï¼Œéœ€è¦%då­—èŠ‚ï¼Œå®é™…åªæœ‰%då­—èŠ‚", frameStart + 9, bytesRead);
              return;
            }

            // æå–9å­—èŠ‚æ•°æ®å¸§
            uint8_t frame[9];
            for (int i = 0; i < 9; i++) {
              frame[i] = buffer[frameStart + i];
            }

            // æ˜¾ç¤ºæ•°æ®å¸§
            ESP_LOGI("voc_uart", "æ•°æ®å¸§: %02X %02X %02X %02X %02X %02X %02X %02X %02X",
                     frame[0], frame[1], frame[2], frame[3], frame[4],
                     frame[5], frame[6], frame[7], frame[8]);

            // è®¡ç®—æ ¡éªŒå’Œ (B1+B2+...+B8çš„ä½8ä½)
            uint8_t checksum = 0;
            for (int i = 0; i < 8; i++) {
              checksum += frame[i];
            }
            checksum = checksum & 0xFF; // å–ä½8ä½

            // éªŒè¯æ ¡éªŒå’Œ
            if (frame[8] != checksum) {
              ESP_LOGW("voc_uart", "âš ï¸ æ ¡éªŒå’Œä¸åŒ¹é…ï¼Œä½†ç»§ç»­è§£ææ•°æ® (æ¥æ”¶: 0x%02X, è®¡ç®—: 0x%02X)", frame[8], checksum);
            }

            // æŒ‰ç…§æ–‡æ¡£åè®®è§£ææ•°æ®
            // TVOCæµ“åº¦ (mg/mÂ³): (B3*256 + B4) Ã— 0.001
            uint16_t tvoc_raw = frame[2] * 256 + frame[3];
            float tvoc_mgm3 = (float)tvoc_raw * 0.001;

            // ç”²é†›æµ“åº¦ (mg/mÂ³): (B5*256 + B6) Ã— 0.001
            uint16_t ch2o_raw = frame[4] * 256 + frame[5];
            float ch2o_mgm3 = (float)ch2o_raw * 0.001;

            // COâ‚‚æµ“åº¦ (mg/mÂ³): (B7*256 + B8) Ã— 0.001
            uint16_t co2_raw = frame[6] * 256 + frame[7];
            float co2_mgm3 = (float)co2_raw * 0.001;

            ESP_LOGI("voc_uart", "âœ… è§£ææˆåŠŸ:");
            ESP_LOGI("voc_uart", "  ğŸŒ¿ TVOC: %.3f mg/mÂ³", tvoc_mgm3);
            ESP_LOGI("voc_uart", "  ğŸ  ç”²é†›(CHâ‚‚O): %.3f mg/mÂ³", ch2o_mgm3);
            ESP_LOGI("voc_uart", "  ğŸ’¨ COâ‚‚: %.3f mg/mÂ³", co2_mgm3);

            // æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥ - ä¸¥æ ¼æŒ‰ç…§C++ä»£ç çš„validateVOCDataå‡½æ•°
            bool data_valid = true;

            // æ£€æŸ¥TVOCèŒƒå›´ (0-10 mg/mÂ³)
            if (tvoc_mgm3 < 0.0 || tvoc_mgm3 > 10.0) {
              ESP_LOGW("voc_uart", "âŒ TVOCæ•°å€¼è¶…å‡ºèŒƒå›´: %.3f mg/mÂ³", tvoc_mgm3);
              data_valid = false;
            }

            // æ£€æŸ¥ç”²é†›èŒƒå›´ (0-2 mg/mÂ³)
            if (ch2o_mgm3 < 0.0 || ch2o_mgm3 > 2.0) {
              ESP_LOGW("voc_uart", "âŒ ç”²é†›æ•°å€¼è¶…å‡ºèŒƒå›´: %.3f mg/mÂ³", ch2o_mgm3);
              data_valid = false;
            }

            // æ£€æŸ¥COâ‚‚èŒƒå›´ (0-10 mg/mÂ³)
            if (co2_mgm3 < 0.0 || co2_mgm3 > 10.0) {
              ESP_LOGW("voc_uart", "âŒ COâ‚‚æ•°å€¼è¶…å‡ºèŒƒå›´: %.3f mg/mÂ³", co2_mgm3);
              data_valid = false;
            }

            if (data_valid) {
              ESP_LOGI("voc_uart", "ğŸ“Š === VOC-CO2-HCHOä¼ æ„Ÿå™¨è¯»æ•° ===");
              ESP_LOGI("voc_uart", "â° æ—¶é—´æˆ³: %lu ms", millis());

              // å‘å¸ƒTVOCæ•°æ®
              if (id(last_tvoc) == -999.0 || abs(tvoc_mgm3 - id(last_tvoc)) >= 0.001) {
                ESP_LOGI("voc_uart", "âœ… å‘å¸ƒTVOC: %.3f mg/mÂ³", tvoc_mgm3);
                id(voc_tvoc).publish_state(tvoc_mgm3);
                id(last_tvoc) = tvoc_mgm3;
              }

              // å‘å¸ƒç”²é†›æ•°æ®
              if (id(last_hcho) == -999.0 || abs(ch2o_mgm3 - id(last_hcho)) >= 0.001) {
                ESP_LOGI("voc_uart", "âœ… å‘å¸ƒç”²é†›: %.3f mg/mÂ³", ch2o_mgm3);
                id(voc_hcho).publish_state(ch2o_mgm3);
                id(last_hcho) = ch2o_mgm3;
              }

              // å‘å¸ƒCOâ‚‚æ•°æ®
              if (id(last_co2) == -999.0 || abs(co2_mgm3 - id(last_co2)) >= 0.001) {
                ESP_LOGI("voc_uart", "âœ… å‘å¸ƒCOâ‚‚: %.3f mg/mÂ³", co2_mgm3);
                id(voc_co2).publish_state(co2_mgm3);
                id(last_co2) = co2_mgm3;
              }

              // ç©ºæ°”è´¨é‡è¯„ä¼°é€»è¾‘ (ä»…åŸºäºTVOCå’Œç”²é†›)
              std::string air_quality = "ä¼˜ç§€";
              int quality_score = 0;

              // TVOCè¯„ä¼° (mg/mÂ³)
              if (tvoc_mgm3 <= 0.3) {
                quality_score += 1; // ä¼˜ç§€
              } else if (tvoc_mgm3 <= 0.6) {
                quality_score += 2; // è‰¯å¥½
              } else if (tvoc_mgm3 <= 1.0) {
                quality_score += 3; // ä¸­ç­‰
              } else if (tvoc_mgm3 <= 3.0) {
                quality_score += 4; // è¾ƒå·®
              } else {
                quality_score += 5; // å¾ˆå·®
              }

              // ç”²é†›è¯„ä¼° (mg/mÂ³)
              if (ch2o_mgm3 <= 0.08) {
                quality_score += 1; // ä¼˜ç§€
              } else if (ch2o_mgm3 <= 0.1) {
                quality_score += 2; // è‰¯å¥½
              } else if (ch2o_mgm3 <= 0.3) {
                quality_score += 3; // ä¸­ç­‰
              } else if (ch2o_mgm3 <= 0.5) {
                quality_score += 4; // è¾ƒå·®
              } else {
                quality_score += 5; // å¾ˆå·®
              }

              // æ ¹æ®ç»¼åˆè¯„åˆ†ç¡®å®šç©ºæ°”è´¨é‡ç­‰çº§ (ä»…åŸºäºTVOCå’Œç”²é†›ï¼Œæ€»åˆ†2-10)
              if (quality_score <= 3) {
                air_quality = "ä¼˜ç§€";
              } else if (quality_score <= 5) {
                air_quality = "è‰¯å¥½";
              } else if (quality_score <= 7) {
                air_quality = "ä¸­ç­‰";
              } else if (quality_score <= 9) {
                air_quality = "è¾ƒå·®";
              } else {
                air_quality = "å¾ˆå·®";
              }

              ESP_LOGI("voc_uart", "ğŸŒŸ ç©ºæ°”è´¨é‡è¯„ä¼°: %s (è¯„åˆ†: %d)", air_quality.c_str(), quality_score);
              ESP_LOGI("voc_uart", "   TVOC: %.3f mg/mÂ³, ç”²é†›: %.3f mg/mÂ³", tvoc_mgm3, ch2o_mgm3);

              // å‘å¸ƒç©ºæ°”è´¨é‡è¯„ä¼°
              if (id(last_air_quality) != air_quality) {
                ESP_LOGI("voc_uart", "âœ… å‘å¸ƒç©ºæ°”è´¨é‡: %s", air_quality.c_str());
                id(air_quality_status).publish_state(air_quality);
                id(last_air_quality) = air_quality;
              }

              // æ„å»ºç»¼åˆJSONæ•°æ®ç”¨äºESP-NOWå¹¿æ’­ (åŒ…å«ç©ºæ°”è´¨é‡è¯„ä¼°)
              std::string json_payload = "{";
              json_payload += "\"tvoc\":" + to_string(tvoc_mgm3) + ",";
              json_payload += "\"formaldehyde\":" + to_string(ch2o_mgm3) + ",";
              json_payload += "\"co2\":" + to_string(co2_mgm3) + ",";
              json_payload += "\"air_quality\":\"" + air_quality + "\",";
              json_payload += "\"quality_score\":" + to_string(quality_score) + ",";
              json_payload += "\"timestamp\":" + to_string(millis()) + ",";
              json_payload += "\"unit\":\"mg/m3\"";
              json_payload += "}";

              // é€šè¿‡ESP-NOWå‘é€æœ€æ–°æ•°æ®
              id(last_espnow_payload) = json_payload;
              id(send_voc_payload_over_espnow).execute();
              ESP_LOGI("voc_uart", "ğŸ“¤ å‘é€ESP-NOWæ•°æ®: %s", json_payload.c_str());

              ESP_LOGI("voc_uart", "===============================");
              ESP_LOGI("voc_uart", "âœ… æ•°æ®è¯»å–å’Œå¤„ç†å®Œæˆ");
            } else {
              ESP_LOGW("voc_uart", "âš ï¸ æ¥æ”¶åˆ°æ•°æ®ä½†éªŒè¯å¤±è´¥");
            }
          } else {
            ESP_LOGW("voc_uart", "â° è¶…æ—¶ï¼Œæœªæ¥æ”¶åˆ°æ•°æ®");
          }

  # VOCä¼ æ„Ÿå™¨ä¸éœ€è¦å‘é€å‘½ä»¤ï¼Œå®ƒä¼šè‡ªåŠ¨å‘é€æ•°æ®

# æ–‡æœ¬ä¼ æ„Ÿå™¨
text_sensor:
  # WiFiä¿¡æ¯
  - platform: wifi_info
    mac_address:
      name: "Mac Address"

  # ç©ºæ°”è´¨é‡è¯„ä¼°
  - platform: template
    name: "Air Quality Assessment"
    id: air_quality_status
    icon: "mdi:air-filter"

# äºŒè¿›åˆ¶ä¼ æ„Ÿå™¨
binary_sensor:
  # è®¾å¤‡çŠ¶æ€
  - platform: status
    name: "Status"

# å¼€å…³æ§åˆ¶
switch:
  # é‡å¯å¼€å…³
  - platform: restart
    name: "Restart"

# æ—¥å¿—é…ç½®
logger:
  baud_rate: 115200
  level: INFO  # æ˜¾ç¤ºä¼ æ„Ÿå™¨æ•°æ®
  logs:
    voc_uart: INFO    # æ˜¾ç¤ºVOCä¼ æ„Ÿå™¨æ•°æ®
    uart_debug: WARN  # å‡å°‘UARTè°ƒè¯•ä¿¡æ¯
    uart: WARN        # å‡å°‘UARTæ—¥å¿—
    wifi: WARN        # å‡å°‘WiFiæ—¥å¿—
    api: WARN         # å‡å°‘APIæ—¥å¿—
    ota: WARN         # å‡å°‘OTAæ—¥å¿—
    web_server: WARN  # å‡å°‘WebæœåŠ¡å™¨æ—¥å¿—

# OTAæ›´æ–°
ota:
  platform: esphome

# APIé…ç½®
api:

# WebæœåŠ¡å™¨
web_server:
  port: 80
  auth:
    username: admin
    password: !secret wifi_password
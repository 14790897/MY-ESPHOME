esphome:
  name: door-opener-esp32c3
  friendly_name: "é—¨é”æŽ§åˆ¶å™¨"
  platformio_options:
    monitor_speed: 115200
    
esp32:
  board: airm2m_core_esp32c3
  framework:
    type: arduino


http_request:
  useragent: esphome/device
  timeout: 10s
  verify_ssl: false
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # ä½ŽåŠŸè€—WiFiè®¾ç½®
  power_save_mode: LIGHT  # è½»åº¦çœç”µæ¨¡å¼
  # å¿«é€Ÿè¿žæŽ¥ï¼Œå‡å°‘å”¤é†’æ—¶é—´
  fast_connect: true

# Home Assistant API - å¿…éœ€ç”¨äºŽé›†æˆ
api:

# OTA æ›´æ–°
ota:
  platform: esphome

# åŒæ­¥ Home Assistant æ—¶é—´
time:
  - platform: homeassistant
    id: ha_time
    on_time:
      # æ¯å¤© 00:00 è¿›å…¥å¤œé—´é•¿ç¡çœ 
      - seconds: 0
        minutes: 0
        hours: 0
        then:
          - logger.log: "è¿›å…¥å¤œé—´æ·±åº¦ç¡çœ "
          - deep_sleep.enter:
              id: deep_sleep_control
              sleep_duration: 8h

# æ·±åº¦ç¡çœ é…ç½®ï¼šå¼€é—¨è®¾å¤‡å¾…æœºæ¨¡å¼ï¼Œæ¯æ¬¡è¿è¡Œ 20 ç§’ï¼Œç¡çœ  3 åˆ†é’Ÿ
deep_sleep:
  id: deep_sleep_control
  # run_duration: 20s       # æ¯æ¬¡è¿è¡Œ 20 ç§’ï¼Œè¶³å¤Ÿå®Œæˆå¼€é—¨æ“ä½œ
  # sleep_duration: 3min    # ç„¶åŽç¡ 3 åˆ†é’Ÿï¼Œå¿«é€Ÿå“åº”å¼€é—¨éœ€æ±‚

# å¯åŠ¨æ—¶æ—¥å¿— - é™ä½Žæ—¥å¿—çº§åˆ«ä»¥èŠ‚çœåŠŸè€—
logger:
  level: WARN  # åªè®°å½•è­¦å‘Šå’Œé”™è¯¯ï¼Œå‡å°‘ä¸²å£è¾“å‡º
  logs:
    deep_sleep: WARN

# å¼€é—¨èˆµæœºæŽ§åˆ¶é…ç½®
servo:
  - id: door_servo
    pin: GPIO2            # ESP32C3 é€‚ç”¨çš„ PWM å¼•è„š
    min_pulse_width: 500us  # æœ€å°è„‰å®½
    max_pulse_width: 2500us # æœ€å¤§è„‰å®½
    idle_pulse_width: 0us   # ç©ºé—²æ—¶å…³é—­PWMä¿¡å·ï¼ŒèŠ‚çœåŠŸè€—
    auto_detach_time: 2s    # 2ç§’åŽè‡ªåŠ¨æ–­å¼€ï¼Œç¡®ä¿å¼€é—¨åŠ¨ä½œå®Œæˆ

# å¼€é—¨æŽ§åˆ¶
number:
  - platform: template
    name: "é—¨é”è§’åº¦"
    id: door_angle
    min_value: 0
    max_value: 180
    step: 1
    initial_value: 0  # é»˜è®¤å…³é—¨ä½ç½®
    optimistic: true
    set_action:
      then:
        - servo.write:
            id: door_servo
            level: !lambda 'return x / 180.0;'
        # 2ç§’åŽè¿›å…¥ç¡çœ ï¼Œç¡®ä¿å¼€é—¨åŠ¨ä½œå®Œæˆ
        - delay: 2s
        - deep_sleep.enter: deep_sleep_control

# å¼€é—¨é¢„è®¾æ“ä½œ
button:
  - platform: template
    name: "ðŸšª å¼€é—¨"
    icon: "mdi:door-open"
    on_press:
      then:
        - logger.log: "æ‰§è¡Œå¼€é—¨æ“ä½œ"
        - servo.write:
            id: door_servo
            level: 1.0  # 180åº¦ï¼Œå®Œå…¨å¼€é—¨
        - number.set:
            id: door_angle
            value: 180
        # å¼€é—¨åŽç­‰å¾…3ç§’ï¼Œç„¶åŽè‡ªåŠ¨å…³é—¨
        - delay: 3s
        - logger.log: "è‡ªåŠ¨å…³é—¨"
        - servo.write:
            id: door_servo
            level: 0.0  # 0åº¦ï¼Œå…³é—¨
        - number.set:
            id: door_angle
            value: 0
        - delay: 2s
        - deep_sleep.enter: deep_sleep_control
        
  - platform: template
    name: "ðŸ”’ å…³é—¨"
    icon: "mdi:door-closed-lock"
    on_press:
      then:
        - logger.log: "æ‰§è¡Œå…³é—¨æ“ä½œ"
        - servo.write:
            id: door_servo
            level: 0.0  # 0åº¦ï¼Œå…³é—¨ä½ç½®
        - number.set:
            id: door_angle
            value: 0
        - delay: 2s
        - deep_sleep.enter: deep_sleep_control
        
  - platform: template
    name: "ðŸ”“ è§£é”ä½ç½®"
    icon: "mdi:lock-open"
    on_press:
      then:
        - logger.log: "ç§»åŠ¨åˆ°è§£é”ä½ç½®"
        - servo.write:
            id: door_servo
            level: 0.5  # 90åº¦ï¼Œä¸­é—´è§£é”ä½ç½®
        - number.set:
            id: door_angle
            value: 90
        - delay: 2s
        - deep_sleep.enter: deep_sleep_control

# è®¾å¤‡çŠ¶æ€ä¼ æ„Ÿå™¨
text_sensor:
  - platform: template
    name: "é—¨é”è®¾å¤‡çŠ¶æ€"
    id: device_status
    update_interval: 60s  # å¢žåŠ æ›´æ–°é—´éš”ï¼ŒèŠ‚çœåŠŸè€—
    lambda: |-
      auto time = id(ha_time).now();
      if (!time.is_valid()) return {"Time not synced"};

      int hour = time.hour;
      if (hour >= 0 && hour < 8) {
        return {"Night sleep mode"};
      } else {
        return {"Ready for door control"};
      }


# ç”µæºå’Œé—¨é”çŠ¶æ€ä¼ æ„Ÿå™¨
sensor:
  - platform: template
    name: "è¿è¡Œæ—¶é—´"
    id: uptime_sensor
    unit_of_measurement: "s"
    update_interval: 30s
    lambda: 'return millis() / 1000.0;'
    
  - platform: template
    name: "é—¨é”è§’åº¦åé¦ˆ"
    id: door_position_feedback
    unit_of_measurement: "Â°"
    update_interval: 5s
    lambda: 'return id(door_angle).state;'


# WebæœåŠ¡å™¨ - è½»é‡çº§é…ç½®
web_server:
  port: 80
  # ç§»é™¤èº«ä»½éªŒè¯ä»¥å‡å°‘å¤„ç†å¼€é”€
  # auth:
  #   username: admin
  #   password: !secret wifi_password


